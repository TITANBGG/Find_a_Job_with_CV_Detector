<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analiz SonuÃ§larÄ± - CV Detector</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>CV Detector</h1>
            <nav>
                <a href="index.html">Ana Sayfa</a>
                <a href="upload.html">CV YÃ¼kle</a>
                <a href="results.html" class="active">SonuÃ§lar</a>
            </nav>
        </header>

        <main>
            <div class="results-section">
                <h2>Analiz SonuÃ§larÄ±</h2>

                <div id="loadingArea" class="loading-area" style="display: none;">
                    <div class="spinner"></div>
                    <p>SonuÃ§lar yÃ¼kleniyor...</p>
                </div>

                <div id="messageArea" class="message-area"></div>

                <div id="resultsContainer" style="display: none;">
                    <!-- Durum Bilgisi -->
                    <div class="result-card">
                        <h3>ðŸ“Š Analiz Durumu</h3>
                        <p id="statusText" class="status-text"></p>
                    </div>

                    <!-- Ä°letiÅŸim Bilgileri -->
                    <div class="result-card" id="contactCard" style="display: none;">
                        <h3>ðŸ“§ Ä°letiÅŸim Bilgileri</h3>
                        
                        <div class="contact-section">
                            <h4>E-posta Adresleri:</h4>
                            <ul id="emailList" class="info-list"></ul>
                        </div>

                        <div class="contact-section">
                            <h4>Telefon NumaralarÄ±:</h4>
                            <ul id="phoneList" class="info-list"></ul>
                        </div>
                    </div>

                    <!-- Teknolojiler -->
                    <div class="result-card" id="techCard" style="display: none;">
                        <h3>ðŸ’» Tespit Edilen Teknolojiler</h3>

                        <!-- Programlama Dilleri -->
                        <div class="tech-category" id="languagesSection" style="display: none;">
                            <h4>Programlama Dilleri</h4>
                            <ul id="languagesList" class="tech-list"></ul>
                        </div>

                        <!-- Frontend -->
                        <div class="tech-category" id="frontendSection" style="display: none;">
                            <h4>Frontend Teknolojileri</h4>
                            <ul id="frontendList" class="tech-list"></ul>
                        </div>

                        <!-- Backend -->
                        <div class="tech-category" id="backendSection" style="display: none;">
                            <h4>Backend Teknolojileri</h4>
                            <ul id="backendList" class="tech-list"></ul>
                        </div>

                        <!-- VeritabanlarÄ± -->
                        <div class="tech-category" id="databasesSection" style="display: none;">
                            <h4>VeritabanlarÄ±</h4>
                            <ul id="databasesList" class="tech-list"></ul>
                        </div>

                        <!-- DevOps -->
                        <div class="tech-category" id="devopsSection" style="display: none;">
                            <h4>DevOps & AraÃ§lar</h4>
                            <ul id="devopsList" class="tech-list"></ul>
                        </div>
                    </div>

                    <!-- Yeni Analiz Butonu -->
                    <div class="action-buttons">
                        <a href="upload.html" class="btn-primary">Yeni CV Analizi</a>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2024 CV Detector - TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>
        </footer>
    </div>

    <script>
        // API base URL
        const API_BASE_URL = 'http://localhost:8000/api';

        // DOM elementleri
        const loadingArea = document.getElementById('loadingArea');
        const messageArea = document.getElementById('messageArea');
        const resultsContainer = document.getElementById('resultsContainer');
        const statusText = document.getElementById('statusText');
        const contactCard = document.getElementById('contactCard');
        const techCard = document.getElementById('techCard');

        // Ä°letiÅŸim listeleri
        const emailList = document.getElementById('emailList');
        const phoneList = document.getElementById('phoneList');

        // Teknoloji listeleri
        const languagesSection = document.getElementById('languagesSection');
        const languagesList = document.getElementById('languagesList');
        const frontendSection = document.getElementById('frontendSection');
        const frontendList = document.getElementById('frontendList');
        const backendSection = document.getElementById('backendSection');
        const backendList = document.getElementById('backendList');
        const databasesSection = document.getElementById('databasesSection');
        const databasesList = document.getElementById('databasesList');
        const devopsSection = document.getElementById('devopsSection');
        const devopsList = document.getElementById('devopsList');

        // Sayfa yÃ¼klendiÄŸinde sonuÃ§larÄ± getir
        document.addEventListener('DOMContentLoaded', function() {
            loadResults();
        });

        /**
         * SonuÃ§larÄ± backend'den getir ve gÃ¶ster
         */
        async function loadResults() {
            // localStorage'dan analysis_id al
            const analysisId = localStorage.getItem('last_analysis_id');

            if (!analysisId) {
                // analysis_id yoksa kullanÄ±cÄ±yÄ± bilgilendir
                showMessage('Ã–nce bir CV yÃ¼klemeniz gerekiyor. LÃ¼tfen <a href="upload.html">CV YÃ¼kle</a> sayfasÄ±na gidin.', 'info');
                return;
            }

            // Loading gÃ¶ster
            loadingArea.style.display = 'block';
            messageArea.innerHTML = '';

            try {
                // Backend'den sonuÃ§larÄ± Ã§ek
                const response = await fetch(`${API_BASE_URL}/results/${analysisId}`);

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Analiz bulunamadÄ±.');
                    } else {
                        throw new Error('SonuÃ§lar alÄ±nÄ±rken bir hata oluÅŸtu.');
                    }
                }

                const data = await response.json();

                // Loading gizle
                loadingArea.style.display = 'none';

                // SonuÃ§larÄ± gÃ¶ster
                displayResults(data);

            } catch (error) {
                console.error('SonuÃ§ alma hatasÄ±:', error);
                loadingArea.style.display = 'none';
                
                if (error.message.includes('Failed to fetch')) {
                    showMessage('Sunucuya baÄŸlanÄ±lamadÄ±. LÃ¼tfen backend\'in Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.', 'error');
                } else {
                    showMessage(error.message, 'error');
                }
            }
        }

        /**
         * SonuÃ§larÄ± ekranda gÃ¶ster
         * @param {Object} data - Backend'den gelen sonuÃ§ verisi
         */
        function displayResults(data) {
            // Results container'Ä± gÃ¶ster
            resultsContainer.style.display = 'block';

            // Status bilgisi
            const statusMap = {
                'done': 'âœ… Analiz tamamlandÄ±',
                'processing': 'â³ Analiz devam ediyor...',
                'pending': 'â³ Analiz sÄ±rasÄ± bekleniyor...',
                'failed': 'âŒ Analiz baÅŸarÄ±sÄ±z oldu'
            };
            statusText.textContent = statusMap[data.status] || data.status;

            // EÄŸer status done deÄŸilse, sadece durumu gÃ¶ster
            if (data.status !== 'done') {
                if (data.status === 'processing' || data.status === 'pending') {
                    showMessage('Analiz henÃ¼z tamamlanmadÄ±. LÃ¼tfen birkaÃ§ saniye sonra sayfayÄ± yenileyin.', 'info');
                }
                return;
            }

            // Ä°letiÅŸim bilgilerini gÃ¶ster
            if (data.emails && data.emails.length > 0) {
                contactCard.style.display = 'block';
                emailList.innerHTML = '';
                data.emails.forEach(email => {
                    const li = document.createElement('li');
                    li.textContent = email;
                    emailList.appendChild(li);
                });
            } else {
                emailList.innerHTML = '<li class="no-data">E-posta bulunamadÄ±</li>';
            }

            if (data.phones && data.phones.length > 0) {
                contactCard.style.display = 'block';
                phoneList.innerHTML = '';
                data.phones.forEach(phone => {
                    const li = document.createElement('li');
                    li.textContent = phone;
                    phoneList.appendChild(li);
                });
            } else {
                phoneList.innerHTML = '<li class="no-data">Telefon bulunamadÄ±</li>';
            }

            // EÄŸer en az bir iletiÅŸim bilgisi varsa card'Ä± gÃ¶ster
            if ((data.emails && data.emails.length > 0) || (data.phones && data.phones.length > 0)) {
                contactCard.style.display = 'block';
            }

            // Teknolojileri gÃ¶ster
            if (data.technologies) {
                let hasTech = false;

                // Languages
                if (data.technologies.languages && data.technologies.languages.length > 0) {
                    displayTechCategory(languagesSection, languagesList, data.technologies.languages);
                    hasTech = true;
                }

                // Frontend
                if (data.technologies.frontend && data.technologies.frontend.length > 0) {
                    displayTechCategory(frontendSection, frontendList, data.technologies.frontend);
                    hasTech = true;
                }

                // Backend
                if (data.technologies.backend && data.technologies.backend.length > 0) {
                    displayTechCategory(backendSection, backendList, data.technologies.backend);
                    hasTech = true;
                }

                // Databases
                if (data.technologies.databases && data.technologies.databases.length > 0) {
                    displayTechCategory(databasesSection, databasesList, data.technologies.databases);
                    hasTech = true;
                }

                // DevOps
                if (data.technologies.devops && data.technologies.devops.length > 0) {
                    displayTechCategory(devopsSection, devopsList, data.technologies.devops);
                    hasTech = true;
                }

                if (hasTech) {
                    techCard.style.display = 'block';
                }
            }
        }

        /**
         * Teknoloji kategorisini gÃ¶ster
         * @param {HTMLElement} section - Kategori section elementi
         * @param {HTMLElement} list - Liste ul elementi
         * @param {Array} technologies - Teknoloji listesi
         */
        function displayTechCategory(section, list, technologies) {
            section.style.display = 'block';
            list.innerHTML = '';
            
            technologies.forEach(tech => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${tech.name}</strong> <span class="count">(${tech.count})</span>`;
                list.appendChild(li);
            });
        }

        /**
         * KullanÄ±cÄ±ya mesaj gÃ¶ster
         * @param {string} message - GÃ¶sterilecek mesaj (HTML destekler)
         * @param {string} type - Mesaj tipi ('success', 'error', 'info')
         */
        function showMessage(message, type) {
            messageArea.innerHTML = `<p>${message}</p>`;
            messageArea.className = `message-area ${type}`;
        }
    </script>
</body>
</html>